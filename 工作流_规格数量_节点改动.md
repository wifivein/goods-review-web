# 工作流「规格数量」改动：2 个节点

## 1. 节点「读取品类配置表」（MySQL）

**改法**：在 SQL 里增加一列 `is_multi_spec`。

**新 SQL（整段替换原查询）**：

```sql
SELECT config_key, display_name, keywords, spec_image_index, spec_image_url, template_name, ref_product_template_id, is_multi_spec
  FROM goods_review_category_config ORDER BY sort_order ASC, id ASC
```

---

## 2. 节点「合并品类」（Code）

**改法**：在兜底对象和输出的 `_category_config` 里都加上 `is_multi_spec`。

**完整 Code（整段替换该节点原代码）**：

```javascript
const task = $('取刚抢占的任务').first().json;
const catRow = $('查品类').first().json;
const rawCategory = (catRow && catRow.product_category) ? String(catRow.product_category).trim() : '';

// 从「读取品类配置表」节点取所有行
const configRows = $('读取品类配置表').all().map(i => i.json);
let matched = null;
for (const r of configRows) {
  const keywords = typeof r.keywords === 'string' ? JSON.parse(r.keywords || '[]') : (r.keywords || []);
  for (const kw of keywords) {
    if (kw && String(kw).trim() && rawCategory.includes(String(kw).trim())) {
      matched = r;
      break;
    }
  }
  if (matched) break;
}
if (!matched) {
  matched = configRows.find(r => r.config_key === 'blanket') || {
    config_key: 'blanket',
    spec_image_index: 2,
    spec_image_url: 'https://img.kwcdn.com/product/20195053a14/c2ddafb8-2eee-497c-9c81-c45254e903bf_800x800.png',
    template_name: '毛毯采集模板',
    ref_product_template_id: 50,
    is_multi_spec: 0
  };
}
const spec_index = Number(matched.spec_image_index) || 2;
const spec_url = (matched.spec_image_url || '').trim() || 'https://img.kwcdn.com/product/20195053a14/c2ddafb8-2eee-497c-9c81-c45254e903bf_800x800.png';
const _category_config = {
  template_name: (matched.template_name || '').trim() || '毛毯采集模板',
  ref_product_template_id: matched.ref_product_template_id != null ? Number(matched.ref_product_template_id) : 50,
  spec_image_index: spec_index,
  spec_image_url: spec_url,
  is_multi_spec: matched.is_multi_spec ? 1 : 0
};
const category_fallback = !matched || matched.config_key === 'blanket';
return [{ json: { ...task, product_category: rawCategory || 'blanket', _category_config, category_fallback } }];
```

---

## 3. 节点「去重并确保规格图在目标位置」（Code）

**改法**：已在本仓库 `工作流_去重并确保规格图在目标位置_Code节点.js` 里改好：`hasMultiSpec` 改为读 `config.is_multi_spec`，不再用 `skuList.length > 1`。把该文件当前内容整段复制进 N8N 里该 Code 节点即可。
