services:
  # 图片标签服务（按 URL 查/写 image_assets）；与 backend 同网，用容器名通信
  ocrplus:
    build:
      context: ../../OCRPlus
      dockerfile: Dockerfile
    container_name: ocrplus
    logging:
      driver: "json-file"
      options:
        max-size: "30m"
        max-file: "3"
    deploy:
      resources:
        limits:
          memory: 1536M
          cpus: "1.0"
        reservations:
          memory: 256M
    environment:
      - DB_HOST=${DB_HOST:-172.17.0.1}
      - DB_PORT=${DB_PORT:-3307}
      - DB_USER=${DB_USER:-root}
      - DB_PASSWORD=${DB_PASSWORD:-root}
      - DB_NAME=${DB_NAME:-temu_baodan}
      - IMAGE_BASE_URL=${IMAGE_BASE_URL:-}
      - IMAGE_BASE_DIR=${IMAGE_BASE_DIR:-/opt/product_images}
    volumes:
      - /opt/product_images:/opt/product_images
      - /opt/images:/opt/images
    ports:
      - "5002:5002"
    restart: unless-stopped
    networks:
      - goods_review_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5002/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

  backend:
    build:
      context: ..
      dockerfile: docker/Dockerfile.backend
    container_name: goods_review_backend
    logging:
      driver: "json-file"
      options:
        max-size: "30m"
        max-file: "3"
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: "1.0"
        reservations:
          memory: 128M
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://127.0.0.1:5000/api/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    # 移除端口映射，统一通过 nginx (8080) 访问
    # ports:
    #   - "5001:5000"
    environment:
      - DB_HOST=${DB_HOST:-172.17.0.1}
      - DB_PORT=${DB_PORT:-3307}
      - DB_USER=${DB_USER:-root}
      - DB_PASSWORD=${DB_PASSWORD:-root}
      - DB_NAME=${DB_NAME:-temu_baodan}
      # 与 ocrplus 同 compose 时用容器名，否则用宿主机地址
      - OCRPLUS_BASE_URL=${OCRPLUS_BASE_URL:-http://ocrplus:5002}
      - SAVE_API_URL=${SAVE_API_URL:-http://temebaodan.all369.cn/api/pc/savegoods}
      - BIGMODEL_API_KEY=${BIGMODEL_API_KEY:-}
      - COS_SECRET_ID=${COS_SECRET_ID:-}
      - COS_SECRET_KEY=${COS_SECRET_KEY:-}
      - COS_REGION=${COS_REGION:-ap-beijing}
      - COS_BUCKET=${COS_BUCKET:-}
      - COS_DOMAIN=${COS_DOMAIN:-}
      - DESIGN_IMAGES_DIR=${DESIGN_IMAGES_DIR:-/opt/images}
      # 预审 Lab 反馈（可选）：配置后保存/废弃会通知 Lab；不配不影响现有逻辑
      - PREVIEW_LAB_URL=${PREVIEW_LAB_URL:-}
    volumes:
      - ../backend:/app
      - /opt/images:/opt/images
    restart: unless-stopped
    networks:
      - goods_review_network
    depends_on:
      ocrplus:
        condition: service_healthy

  # 预审改进支撑系统（与 backend 平级，独立代码；同网同 MySQL 实例，库名 temu_baodan_lab）
  preview-lab:
    build:
      context: ../../preview-lab
      dockerfile: docker/Dockerfile
    container_name: preview_lab
    logging:
      driver: "json-file"
      options:
        max-size: "20m"
        max-file: "2"
    environment:
      - DB_HOST=${DB_HOST:-172.17.0.1}
      - DB_PORT=${DB_PORT:-3307}
      - DB_USER=${DB_USER:-root}
      - DB_PASSWORD=${DB_PASSWORD:-root}
      - DB_NAME_LAB=${DB_NAME_LAB:-temu_baodan_lab}
    ports:
      - "5003:5003"
    restart: unless-stopped
    networks:
      - goods_review_network

  frontend:
    image: nginx:alpine
    container_name: goods_review_frontend
    logging:
      driver: "json-file"
      options:
        max-size: "30m"
        max-file: "3"
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: "0.25"
    ports:
      - "8080:80"
    volumes:
      - ../frontend:/usr/share/nginx/html:ro
      - /opt/product_images:/usr/share/nginx/html/product_images:ro
      - /opt/images:/opt/images:ro
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
    restart: unless-stopped
    networks:
      - goods_review_network
    depends_on:
      backend:
        condition: service_healthy

networks:
  goods_review_network:
    driver: bridge
