# goods_review_web 审核功能扩品类改造：方案与待定项

## 一、现状：和毛毯绑死的地方

| 位置 | 写死内容 | 改造方向 |
|------|----------|----------|
| **backend/app.py** | | |
| 约 49–50 行 | `BLANKET_SPEC_IMAGE_URL` 常量 | 改为「品类配置」中的 `spec_image_url` |
| 约 364–369 行 | `_process_goods_row`：`query_list[2] = replaced_3rd`（加回原图固定第 3 位） | 用该商品品类的 `spec_image_index`，不再写死 2 |
| 约 1480–1515 行 | `approve_goods()`：`image_list[2]`、`BLANKET_SPEC_IMAGE_URL`、`replaced_3rd_image_url` | 按品类取 `spec_image_index` / `spec_image_url`，替换第 N 张、SKU 对应 pic、存被替换原图 |
| 约 1573 行 | `_notify_preview_lab_feedback(..., spec_image_index: 2)` | `spec_image_index` 从品类配置读 |
| **frontend** | | |
| index.html | 文案「第3张」、`goods.image_list[2]`、点击索引 2、按钮「更换第3张图」 | 用 `goods.spec_image_index` 取图与索引；文案改为「规格图」或「第 N 张」 |
| app.js | `target_index: 2`、`index === 2`、提示「第3张」 | 全部改为用 `goods.spec_image_index` |

品类来源与 N8N 一致：**access_logs 的 product_category**（按 goods_id 取最新），用**关键词匹配**得到 configKey（如 blanket），再查配置得到 `spec_image_index`、`spec_image_url`。

---

## 二、方案概要

### 1. 品类与配置（后端）

- **品类解析**：根据商品的 `product_id` 查 access_logs 表，取最新一条的 `product_category` 字符串；用**关键词匹配**得到 configKey（与 N8N 合并品类节点逻辑一致）；无记录或未匹配时使用默认 configKey（如 `blanket`）。
- **配置内容**：每个 configKey 对应 `spec_image_index`、`spec_image_url`。
  - 示例：`blanket` → index=2，url=现 `BLANKET_SPEC_IMAGE_URL`；后续新品类如挂毯 → index=1，url=另一张图。
- **配置存放**：建议先**代码内 dict**（与 N8N 工作流内 map 一致，易找易改）；若你希望运营可改，再迁到 DB（如 `goods_review_config`）。

### 2. 后端改动点

| 项 | 说明 |
|----|------|
| **品类配置 + 关键词** | 定义 `CATEGORY_KEYWORDS`（product_category 字符串命中哪些关键词→configKey）、`CATEGORY_SPEC`（configKey→spec_image_index、spec_image_url）；提供「根据 product_id 查 access_logs → 匹配 → 取 spec」的辅助函数。 |
| **列表/详情带出 spec** | 在 `get_goods_list` / `get_goods_detail` 中，对每条商品用 `product_id` 查品类并解析，将 `spec_image_index`、`spec_image_url` 写入该条商品再返回（可放在 `_process_goods_row` 之前或之内，保证前端拿到的每条商品都有这两个字段）。 |
| **`_process_goods_row`** | 加回「被替换掉的原图」时：用 `row.get('spec_image_index', 2)` 决定插入位置，即 `query_list[spec_image_index] = replaced_3rd`；若 row 尚未带 `spec_image_index`，则由调用方在调用前根据 access_logs 写好。 |
| **`approve_goods`** | 根据该商品 product_id 解析品类，取 `spec_image_index`、`spec_image_url`；替换 `image_list[spec_image_index]`、SKU 中对应 pic；`replaced_3rd_image_url` 存被替换掉的那张原图（语义改为「规格图位的原 URL」）；preview-lab 的 payload 中 `spec_image_index` 用配置值。 |
| **作废逻辑** | 保留「不足 3 张作废」或改为「不足 N 张作废」（N 可由品类配置，见下「待定」）。 |

### 3. 前端改动点

| 项 | 说明 |
|----|------|
| **展示** | 列表/详情中「第3张」改为用 `goods.spec_image_index`：取 `goods.image_list[goods.spec_image_index]` 展示；文案改为「规格图」或「第 N 张」（N = spec_image_index + 1）。 |
| **点击与按钮** | 规格图格点击时传的 index 为 `goods.spec_image_index`；「更换第3张图」改为「更换规格图」，调用 swap-image 时 `target_index: goods.spec_image_index`；disabled 条件改为「当前选中的已是规格图位」即 `currentActionImageIndex === goods.spec_image_index`。 |
| **app.js** | 所有写死的 `2`、`index === 2`、`target_index: 2` 改为使用当前商品的 `spec_image_index`；提示文案从「第3张」改为「规格图」或「第 N 张」。 |

### 4. 数据库

- **temu_goods_v2**：不强制加 `product_category` 字段；品类由 access_logs + 关键词匹配在接口内实时算即可。若你希望减少重复查 access_logs，可后续再加该字段并 backfill。
- **replaced_3rd_image_url**：保留字段名，语义改为「审核通过时被替换掉的规格图位置原 URL」（见下「待定」是否新加 `replaced_spec_image_url`）。

---

## 三、需要你定的项

### 1. 品类来源方式（二选一或组合）

- **A）仅 access_logs**  
  列表/详情/审核时都用 `product_id` 查 access_logs 取 `product_category`，再关键词匹配。不改表，与 N8N 一致。  
- **B）temu_goods_v2 增加 product_category**  
  表加字段并 backfill（如从 access_logs 按 goods_id 回填），列表/详情/审核读该字段再匹配。少查 access_logs，多一次表结构变更与 backfill。

**建议**：先 A，后续若性能有要求再 B。

---

### 2. 配置存放

- **代码内 dict**：与 N8N 一致，改代码发版才能改品类/URL。  
- **DB 表**（如 `goods_review_config`）：ckey 如 `category_spec_blanket`，cvalue JSON 存 `{"spec_image_index":2,"spec_image_url":"https://..."}`，运营可改。

你更倾向哪种？若选 DB，是否已有 `goods_review_config` 表或希望新建？

---

### 3. 关键词匹配规则

- **与 N8N 一致**：后端维护一份与「合并品类」节点相同的 `CATEGORY_KEYWORDS`（如 blanket: ['毯子','盖毯','毛毯']），保证整理与审核用同一套规则。  
- **审核侧单独一份**：审核用另一套关键词，与 N8N 解耦但需维护两处。

建议与 N8N 一致，便于以后加品类只改一处（或一份共享配置）。

---

### 4. 无品类 / 未匹配时的默认

- 是否默认按 **blanket**（index=2 + 现有毛毯规格图 URL）？  
建议：是，与 N8N 默认行为一致。

---

### 5. 前端文案

- 「第3张」改为：
  - **「规格图」**：不暴露具体第几张，适合多品类；
  - **「第 N 张」**（N = spec_image_index + 1）：更具体，便于对图。

你选哪一种？

---

### 6. replaced_3rd_image_url 字段

- **保留字段名**：语义改为「被替换的规格图位置原 URL」，代码里按 `spec_image_index` 写/读。  
- **新加 replaced_spec_image_url**：新字段专存「被替换的规格图 URL」，旧字段逐步废弃。

建议先保留字段名、只改语义，避免一次性改表与历史数据。

---

### 7. 作废逻辑（不足张数）

- 当前：不足 3 张即作废。  
- 是否改为**按品类配置「最少轮播张数」**（如某品类要求至少 5 张）？  
若暂不按品类区分，可保留「不足 3 张作废」，与现有一致。

---

### 8. access_logs 表与连接方式

- 确认 **goods_review_web 使用的库**是否已包含 **access_logs** 表且含 `product_category`、`goods_id`（或与 product_id 对应）。  
- 若与 N8N/插件不是同一库，需要你指定：审核侧查的是哪个库、哪张表、哪个字段作为 goods_id。

---

## 四、小结

- **改造范围**：后端「品类解析 + 配置」、列表/详情带出 `spec_image_index`/`spec_image_url`、`_process_goods_row` 加回原图用 N、`approve_goods` 按品类替换第 N 张并通知 preview-lab；前端展示与「更换规格图」全用 `spec_image_index`，文案去「第3张」写死。
- **你定完上述 8 点后**，我可以按你的选择给出具体改动清单（改哪些文件、哪些行、代码片段），方便你直接改或交给我按清单改。
