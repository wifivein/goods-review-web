# 最终修复方案：处理Unicode编码匹配问题

## 问题分析

从调试信息看：
- 查找目标：`"31608983628方巾2"`（正常中文字符）
- 找到的元素：`"31608983628\\u65b9\\u5dfe2"`（Unicode编码格式）

`\u65b9\u5dfe` 是"方巾"的Unicode编码。DOM中的文本可能是字符串字面量格式。

## 解决方案

使用更智能的匹配方式，同时处理：
1. 正常中文字符匹配
2. Unicode编码字符串字面量匹配
3. 部分匹配（包含关系）

## 修复后的脚本

```javascript
try { 
  const name = args.targetName.trim(); 
  const allNames = Array.from(document.querySelectorAll("div[class*='text-ellipsis'][class*='font-semibold']")); 
  
  // 解码Unicode字符串字面量（如 "\\u65b9" -> "方"）
  const decodeUnicodeStr = (str) => {
    try {
      // 尝试使用JSON.parse解码
      return JSON.parse('"' + str.replace(/\\/g, '\\\\').replace(/"/g, '\\"') + '"');
    } catch(e) {
      // 如果失败，手动替换Unicode转义序列
      return str.replace(/\\u([0-9a-fA-F]{4})/g, (match, code) => 
        String.fromCharCode(parseInt(code, 16))
      );
    }
  };
  
  // 规范化文本：去除所有Unicode编码，统一为正常字符
  const normalizeText = (text) => {
    const decoded = decodeUnicodeStr(text);
    // 如果解码后和原文本不同，使用解码后的；否则使用原文本
    return decoded !== text ? decoded : text;
  };
  
  const targetEl = allNames.find(el => { 
    const text = el.textContent.trim(); 
    const normalized = normalizeText(text);
    
    // 多种匹配方式
    return text === name || 
           normalized === name || 
           text.includes(name) || 
           name.includes(text) || 
           normalized.includes(name) || 
           name.includes(normalized);
  }); 
  
  if (!targetEl) { 
    const foundTexts = allNames.map(el => {
      const text = el.textContent.trim();
      return { original: text, normalized: normalizeText(text) };
    });
    return { 
      status: 'fail', 
      msg: `Name not found. Looking for: "${name}". Found ${allNames.length} elements.`,
      debug: {
        lookingFor: name,
        foundCount: allNames.length,
        foundTexts: foundTexts
      }
    }; 
  } 
  
  const btn = targetEl.parentElement.nextElementSibling.querySelector('button'); 
  if (btn) { 
    btn.parentElement.style.visibility='visible'; 
    btn.click(); 
    return { status: 'success' }; 
  } 
  return { status: 'fail', msg: 'Btn not found' }; 
} catch(e) { 
  return { status: 'error', msg: e.toString() }; 
}
```

## 在n8n中的配置

将 `jsonBody` 中的 `script` 字段替换为上述脚本（注意转义）。

## 关键改进

1. **智能Unicode解码**：使用 `JSON.parse` 和手动替换两种方式
2. **文本规范化**：统一处理Unicode编码和正常字符
3. **多种匹配方式**：精确匹配、包含匹配、规范化后匹配
4. **详细调试信息**：返回原始文本和规范化后的文本，便于排查
