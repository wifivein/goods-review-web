# 整理工作流：规格图细分融入（简化版 - 调 spec-sublabel 接口）

- **第一步（已有）**：分类打标，`image_type=spec` 的为规格图。
- **第二步（简化）**：对每张规格图调一次 **规格图细分打标接口** `POST /api/vision/spec-sublabel`，接口内部完成：多规格/单规格判断 + 单规格时抽维度（提示词从 preview-lab 按场景名拉取，大模型返回的维度内容原样包装，不做换算）。
- **第三步**：把接口返回的 `spec_subtype`、`spec_dimensions` 按 index 写回 labels，合并后接计时Vision后、拼轮播图、写 OCRPlus。

**约定**：不用 Merge。跨节点用 `$('节点名')` 取数；合成在 Code 里。N8N 社区版即可。

preview-lab 需有 `spec_subtype`、`spec_dimension` 两个 scene 的提示词；接口固定用 `http://preview-lab:5003` 拉取。

---

## 接口说明（goods_review_web 已实现）

- **URL**：`POST http://goods_review_frontend/api/vision/spec-sublabel`
- **请求体**：`{ "image_url": "必填", "scene_subtype": "spec_subtype", "scene_dimension": "spec_dimension" }`，后两键可选，有默认值。
- **响应**：`{ "code": 0, "message": "success", "data": { "spec_subtype": "multi_spec"|"single_spec", "spec_dimensions": {...}|null } }`。`spec_dimensions` 为大模型返回的 JSON 对象原样，不做单位换算或字段重写。

---

下面按**执行顺序**列出节点：**新增/修改**、**上游/下游**、**完整代码或配置**。

---

## 节点 1：规格图细分-展开

| 项目 | 内容 |
|------|------|
| **新增/修改** | 新增 |
| **类型** | Code |
| **上游** | 汇总Vision打标结果 |
| **下游** | IF_no_spec |

**说明**：只读 `$('汇总Vision打标结果')`，不拉 prompt。无规格图时输出 1 条 no_spec；有则输出 N 条（每张规格图一条）。

**代码（完整替换）：**

```javascript
const visionNode = $('汇总Vision打标结果').first().json;
const labels = visionNode.labels || [];
const carousel = visionNode.carousel || [];

const specIndices = [];
labels.forEach((l, i) => {
  if (l && l.image_type === 'spec') specIndices.push(i);
});

if (specIndices.length === 0) {
  return [{ json: { no_spec: true, labels, carousel } }];
}

return specIndices.map(i => {
  const lab = labels[i] || {};
  return {
    json: {
      spec_index: i,
      original_url: lab.original_url || lab.image_url || carousel[i] || '',
      labels,
      carousel
    }
  };
});
```

---

## 节点 2：IF_no_spec

| 项目 | 内容 |
|------|------|
| **新增/修改** | 新增 |
| **类型** | IF |
| **上游** | 规格图细分-展开 |
| **下游** | true → 合并规格图细分结果；false → 调spec_sublabel |

**配置：** 条件 `{{ $json.no_spec }}` 等于 `true`

---

## 节点 3：调spec_sublabel

| 项目 | 内容 |
|------|------|
| **新增/修改** | 新增 |
| **类型** | HTTP Request |
| **上游** | IF_no_spec（false 分支） |
| **下游** | 合并规格图细分结果 |

**配置：**
- 方法：POST
- URL：`http://goods_review_frontend/api/vision/spec-sublabel`
- Body 选 JSON，用表达式整段生成（避免 prompt 换行等问题）：

```javascript
={{ JSON.stringify({
  image_url: $json.original_url,
  scene_subtype: 'spec_subtype',
  scene_dimension: 'spec_dimension'
}) }}
```

（若 N8N 不支持 Body 用表达式，则写死 `{"image_url": "{{ $json.original_url }}", "scene_subtype": "spec_subtype", "scene_dimension": "spec_dimension"}`。）

---

## 节点 4：合并规格图细分结果

| 项目 | 内容 |
|------|------|
| **新增/修改** | 新增 |
| **类型** | Code |
| **上游** | 两路：① IF_no_spec（true）② 调spec_sublabel |
| **下游** | 计时Vision后 |

**说明**：用节点名取数。若当前输入含 no_spec，直接输出该条 labels/carousel；否则用 规格图细分-展开 的 labels/carousel + 调spec_sublabel 的 N 条结果按顺序写回 spec_subtype、spec_dimensions。

**代码（完整替换）：**

```javascript
const items = $input.all().map(i => i.json);
const noSpecItem = items.find(x => x.no_spec === true);
if (noSpecItem) {
  return [{ json: { labels: noSpecItem.labels || [], carousel: noSpecItem.carousel || [] } }];
}

const expandItems = $('规格图细分-展开').all().map(i => i.json).filter(x => !x.no_spec);
const sublabelItems = $('调spec_sublabel').all().map(i => i.json);
if (expandItems.length !== sublabelItems.length) {
  return [{ json: { error: '展开条数与 spec_sublabel 条数不一致', labels: expandItems[0]?.labels || [], carousel: expandItems[0]?.carousel || [] } }];
}

const byIndex = {};
sublabelItems.forEach((item, idx) => {
  const exp = expandItems[idx];
  if (!exp || exp.spec_index === undefined) return;
  const data = item.data || item;
  byIndex[exp.spec_index] = {
    spec_subtype: data.spec_subtype ?? null,
    spec_dimensions: data.spec_dimensions ?? null
  };
});

const first = expandItems[0];
const labels = (first.labels || []).map((lab, i) => {
  const ext = byIndex[i];
  if (!ext) return lab;
  return { ...lab, spec_subtype: ext.spec_subtype, spec_dimensions: ext.spec_dimensions };
});
return [{ json: { labels, carousel: first.carousel || [] } }];
```

---

## 节点 5：计时Vision后（修改连线）

| 项目 | 内容 |
|------|------|
| **新增/修改** | 修改 |
| **类型** | 不变 |
| **上游** | **改为**：合并规格图细分结果（删掉原「汇总Vision打标结果 → 计时Vision后」） |
| **下游** | 不变 |

---

## 节点 6：准备轮播图打标（修改代码）

| 项目 | 内容 |
|------|------|
| **新增/修改** | 修改 |
| **类型** | Code |
| **上游/下游** | 不变 |

取 labels/carousel 优先从「合并规格图细分结果」取，组装 `carousel_labels` 时每条增加 `spec_subtype`、`spec_dimensions`（见此前说明，逻辑不变）。

---

## 节点 7：拼轮播图labels给OCRPlus（修改代码）

| 项目 | 内容 |
|------|------|
| **新增/修改** | 修改 |
| **类型** | Code |
| **上游/下游** | 不变 |

**说明**：必须优先从「合并规格图细分结果」取 labels（带 spec_subtype/spec_dimensions），否则会全是 null。

**代码（完整替换）：**

```javascript
let labels = [];
try {
  if ($('合并规格图细分结果').isExecuted && $('合并规格图细分结果').first().json) {
    const merged = $('合并规格图细分结果').first().json;
    labels = merged.labels || [];
  }
}
catch (e) {}
if (!labels.length) {
  const productData = $('汇总Vision打标结果').first().json;
  labels = productData.labels || productData.carousel_labels || [];
}
const carousel = ($('合并规格图细分结果').isExecuted && $('合并规格图细分结果').first().json)
  ? ($('合并规格图细分结果').first().json.carousel || [])
  : ($('汇总Vision打标结果').first().json.carousel || []);

const items = labels.map((lab, i) => {
  const url = lab.original_url || lab.image_url || carousel[i] || '';
  return {
    url,
    labels: {
      image_type: lab.image_type || 'other',
      product_complete: lab.product_complete === true,
      shape: lab.shape ?? 'unknown',
      design_desc: lab.design_desc != null ? String(lab.design_desc) : '',
      quality_ok: lab.quality_ok !== false,
      label_failed: lab.label_failed === true,
      spec_subtype: lab.spec_subtype ?? null,
      spec_dimensions: lab.spec_dimensions ?? null
    },
    label_source: 'goods_carousel'
  };
}).filter(x => x.url);

const passThrough = $input.first().json;
return [{ json: { ...passThrough, _ocrplus_batch_items: items } }];
```

---

## 连线汇总（简化版）

| 上游节点 | 下游节点 |
|----------|----------|
| 汇总Vision打标结果 | 规格图细分-展开 |
| 规格图细分-展开 | IF_no_spec |
| IF_no_spec (true) | 合并规格图细分结果 |
| IF_no_spec (false) | 调spec_sublabel |
| 调spec_sublabel | 合并规格图细分结果 |
| 合并规格图细分结果 | 计时Vision后 |

**注意**：删掉原「汇总Vision打标结果 → 计时Vision后」。不再需要 获取spec_subtype的Prompt、获取spec_dimension的Prompt、调vision_spec_subtype、解析spec_subtype、是否single_spec、调vision_spec_dimension、解析spec_dimension、spec_dimensions置空 等节点。

---

## 审核页（Web）

- 列表/详情「图片类型」：`image_type === 'spec'` 时统一展示「规格图」。
- `spec_subtype`、`spec_dimensions` 存 OCRPlus，审核页可在详情/原始标签中展示；`spec_dimensions` 可能为大模型原始结构（如 width/height/unit），便于对照提示词调试。
