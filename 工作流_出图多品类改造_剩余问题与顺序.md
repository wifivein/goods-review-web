# 出图工作流多品类改造：剩余问题与改造顺序

## 一、剩余问题（待定/需统一）

1. **category → config_key 解析**
   - 上游只传 `category`（页面 DOM 文本，如「小盖毯、午休毯」「女士户外多功能头饰」），没有 config_key。
   - goods_review_web 现有 `_resolve_category_for_product_id` 是按 product_id 查 access_logs 的 product_category 再匹配 keywords，出图流没有 product_id。
   - **需二选一**：  
     - **A**：goods_review_web 新增 `GET /api/category-config/resolve?category=xxx`，入参为 category 文本，用 keywords/display_name 包含关系匹配，返回 `{ config_key, display_name }`，未匹配 404。  
     - **B**：出图流里先 HTTP 调 `GET /api/category-config` 拿全量，再用 Code 节点用 category 文本匹配 keywords/display_name 得到 config_key。
   - 匹配规则与现有一致：`keywords` 中任意一个关键词出现在 category 文本中即命中；可同时支持 `display_name` 出现在 category 中即命中。

2. **preview-lab 场景名**
   - 约定：`scene = "lovart_design_" + config_key`，例如 `lovart_design_blanket`、`lovart_design_scarf`。
   - 在 preview-lab 为各品类建对应 scene，并设好当前版本 prompt。

3. **提示词变量**
   - 模板里占位符格式统一，例如：`{{skc}}`、`{{category}}`、`{{image_url}}`（若需要）。
   - N8N 拉取 `GET /api/prompt/current?scene=xxx` 得到 `content` 后，在出图流里做字符串替换再填入 Lovart 输入框；Lovart 会按这些信息命名出图，便于下载后区分商品。

4. **skc 格式**
   - 上游「比较差异」里已输出纯数字 `skc`，Call 出图时传的也是该数字，无需再在出图流里从「SKC：123」里截取。若上游有变动需再确认。

5. **未配置品类（桌布/挂毯等）**
   - 解析不到 config_key，或 preview-lab 该 scene 无当前 prompt（404）→ 企微通知「有 [category 原文] 出单啦，请及时处理（并补充提示词）」→ 不提交 Lovart。
   - 不在 DB 写状态（出图流当前也不写 DB，保持即可）。

6. **保存目录**
   - 固定 Win1 本地目录，例如 `C:\Users\vein\Desktop\已出单图片`（与上游「查找本地图片目录」一致），不再按品类分子目录或从配置表读。

---

## 二、改造顺序（建议）

| 步骤 | 内容 | 说明 |
|------|------|------|
| 1 | **品类解析** | 选 A 或 B：要么 goods_review_web 加 resolve 接口，要么出图流「HTTP 拉全量 + Code 匹配」。 |
| 2 | **preview-lab 场景** | 按 `lovart_design_<config_key>` 建 scene（如 blanket、scarf），每个 scene 至少有一个当前版本的 prompt；模板内用 `{{skc}}`、`{{category}}` 等占位符。 |
| 3 | **出图流：解析 + 拉 prompt** | Start 后先得到 config_key（步骤 1）；再 `GET /api/prompt/current?scene=lovart_design_{{config_key}}`，若 404 则企微通知并结束，否则继续。 |
| 4 | **出图流：替换变量** | 将 prompt content 里的 `{{skc}}`、`{{category}}` 等替换为当前商品的 skc、category，得到最终 prompt 文本。 |
| 5 | **出图流：单路径提交 Lovart** | 不再按 category 多分支写死提示词；统一为「一个分支」：用替换后的 prompt 填 Lovart 输入框并提交。 |
| 6 | **出图流：保存目录固定** | 保存首图时目录固定为 Win1 的 `C:\Users\vein\Desktop\已出单图片`（或你指定的同一目录）。 |
| 7 | **未配置品类分支** | 仅保留「解析失败或 prompt 404」时的企微通知，不调用 Lovart；桌布/挂毯一旦出单会走该分支并提醒你补提示词。 |

---

## 三、小结

- **必须先定**：category → config_key 用接口（A）还是 N8N 自算（B）。  
- **然后**：preview-lab 按品类 scene 建好 prompt，再改出图流为「解析 → 拉 prompt → 替换变量 → 提交 Lovart → 固定目录保存」。  
- 上游工作流无需改，继续传 `image_url`、`skc`、`category` 即可。
