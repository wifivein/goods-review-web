# 审核页卡顿时在服务器上看的配置与日志

部署/重启 goods_review_web 后，后端会打 `[PERF]` 日志。在卡顿时上服务器执行下面命令，用于判断瓶颈在 DB 还是 OCRPlus。

---

## 1. 看当前配置（是否需要加日志前先确认）

```bash
# goods_review_web 进程数（若为 1 且整理占满，会阻塞审核请求）
ps aux | grep -E "gunicorn|flask|python.*app.py" | grep -v grep

# 若用 gunicorn，看 worker 数
grep -E "workers|workers=" /path/to/gunicorn.conf 2>/dev/null || true

# MySQL 当前连接数（与 goods_review_web、N8N、OCRPlus 等共用）
mysql -u根用户 -p -e "SHOW STATUS LIKE 'Threads_connected';"  # 或登录后执行
```

---

## 2. 看 [PERF] 日志（区分 DB 与 OCRPlus）

日志已加在：
- `GET /api/goods/list`：总耗时 >800ms 时打一条，含 `db_conn_ms`、`db_query_ms`、`db_category_ms`、`ocrplus_ms`、`total_ms`、`url_count`
- `GET /api/goods/detail/<id>`：总耗时 >500ms 时打一条，同上
- `_fetch_labels_by_urls`：OCRPlus 异常/非 200 或耗时 >1s 时打 `OCRPlus by-url url_count=... elapsed_ms=...`

```bash
# 看最近 50 条 PERF（按你实际日志路径改）
tail -n 500 /path/to/goods_review_web.log | grep "\[PERF\]"

# 或若用 docker / systemd，先找到日志输出位置
docker logs --tail 500 <goods_review_web容器名> 2>&1 | grep "\[PERF\]"
journalctl -u <goods_review_web服务名> -n 500 --no-pager | grep "\[PERF\]"
```

看哪一块大：
- **ocrplus_ms 接近 5000 或很多 OCRPlus by-url error** → 瓶颈在 OCRPlus 或网络
- **db_conn_ms + db_query_ms + db_category_ms 很大** → 瓶颈在 DB 或连接

---

## 3. 日志路径（按你实际部署）

- 直接跑：控制台 stdout，需重定向到文件才有 tail
- Docker：`docker logs` 或挂载的日志卷
- systemd：`journalctl -u <unit>`
- 若当前没落盘：可在启动命令加 `>> /var/log/goods_review_web.log 2>&1` 或改 systemd/docker 的 StandardOutput
